I"5.<p>Open Distro for Elasticsearch has extensive access control capabilities built right in. Of course, access control can prevent access to sensitive information, but it can also help you build applications that depend on Open Distro for Elasticsearch for search. Let’s explore this a little more.</p>

<p><img src="/assets/media/blog-images/2020-10-27-fine-grained-access-control-for-search/fgac-fields.png" alt="User A and User B access the same document and get different results" class="img-fluid" /></p>

<p>Say your application uses standard HTTP endpoints to serve data to end users. So, a web user loads a webpage, the client-side Javascript fires off a HTTP request to the application endpoint for a specific type of data, the data is returned to the client-side Javascript, and the browser renders it on screen for the user. Your server code is doing some minor handling of the HTTP route and parameters, making a request to Elasticsearch based on this and manipulating the returned results to make it easily useable by the client-side Javascript. Pretty typical stuff.</p>

<p>When your application becomes sufficiently complex, you’ll probably find the code is generally repetitious. You’ll be writing almost the same methods over and over - listen for a HTTP request, process it, ask Elasticsearch, return results, yet with small, subtle differences. Not only is this boring to write, it represents a larger, harder to maintain codebase. So, how does <em>access control</em> fit into all this?</p>

<p>By varying the Open Distro for Elasticsearch users for types of different requests, you can change the data returned. In this scenario you have documents that represent items - these documents can contain not only public facing fields - price, colour, material, description, but also private fields like cost, suppliers, and performance. Your employees may need to see all the information from behind a special login while customers should only see the public information. Of course, you could write very similar server code for each, vary the <code class="language-plaintext highlighter-rouge">_source</code> in the Query DSL and reimplement loads of logic. Alternatively, you can let Open Distro do this work for you and gain the ability to centrally control field availability.</p>

<p>Let’s take this example - running this in query in Kibana Dev Tools (<code class="language-plaintext highlighter-rouge">&lt;yourhost&gt;:&lt;yourport&gt;/app/dev_tools#/console</code>) we will add a single item to the index <code class="language-plaintext highlighter-rouge">ecommerce-items</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT ecommerce-items/_doc/brown-mug
{
    "title": "Brown Mug",
    "description": "This mug features a large handle and a marbled, brown ceramic design.",
    "price" : 5.99,
    "private" : {
        "cost" : 1,
        "supplier" : "Mug World"
     }
}
</code></pre></div></div>

<p>No matter what happens, we don’t want our customers to be able to see anything in the <code class="language-plaintext highlighter-rouge">private</code> object. We’ll use Open Distro’s built-in access control functionality to make this happen.</p>

<h2 id="creating-a-user--role">Creating a user &amp; role</h2>

<p>First up in Kibana we need to create a user. This user will be used by the application for serving public information, so we’ll call it <code class="language-plaintext highlighter-rouge">public-item-user</code>. First, go to the <strong>Security</strong> item from the side menu then click <strong>Internal users</strong> in the secondary menu. Now, click on the <strong>Create internal user</strong> button. This will take you to <code class="language-plaintext highlighter-rouge">&lt;yourhost&gt;:&lt;yourport&gt;/app/opendistro_security#/users/create</code>.</p>

<p>Under the heading “Credentials” enter the username of <code class="language-plaintext highlighter-rouge">public-item-user</code> and a password twice for validation. Then click the <strong>Create</strong> button. At this point we have created a user but it can’t do anything in Open Distro. To enable it to be useful, we’ll have to create and assign a role.</p>

<p>From the side menu, go back to <strong>Security</strong> and then <strong>Roles</strong> from the secondary menu then click the <strong>Create role</strong> button. You should be at <code class="language-plaintext highlighter-rouge">&lt;yourhost&gt;:&lt;yourport&gt;/app/opendistro_security#/roles/create</code>. Under the “Name” heading enter <code class="language-plaintext highlighter-rouge">public-item-viewer</code> into the “Name” text box. Then under the heading “Index Permissions” add the <code class="language-plaintext highlighter-rouge">ecommerce-items</code> in the “Index” field and then <code class="language-plaintext highlighter-rouge">indices:data/read/search</code> into the “Index Permissions” field. Finally, under the heading “Field level security” go to the “Exclude” field and enter <code class="language-plaintext highlighter-rouge">private</code>. When you’ve done all this, go to the bottom and click the <strong>Create</strong> button.</p>

<p>Before proceeding, let’s take a moment to examine why <code class="language-plaintext highlighter-rouge">indices:data/read/search</code> is the right permission for this situation. It grants users with this role the ability to search documents but not to manipulate them. If you scroll through the possibilities in the “Index Permissions” box you might notice the type <code class="language-plaintext highlighter-rouge">crud</code> and <code class="language-plaintext highlighter-rouge">search</code> which are permission groups. Permission groups bundle typically used permissions together as a shorthand; you could actually use these here, but you would also be granting far more permission than needed, so we’ll stick with a highly specific permission that can do very little (more on that later).</p>

<p>At this point you have a user, <code class="language-plaintext highlighter-rouge">public-item-user</code> and a role <code class="language-plaintext highlighter-rouge">public-item-viewer</code> but they aren’t connected. In Open Distro this is called <em>mapping</em>. To map a role to a user, go back to <strong>Security</strong> and then select <strong>Roles</strong> and find our user (<code class="language-plaintext highlighter-rouge">public-item-viewer</code>) and click on it (you may need to use the search box). It should bring you to <code class="language-plaintext highlighter-rouge">&lt;yourhost&gt;:&lt;yourport&gt;/app/opendistro_security#/roles/view/public-item-viewer</code>.  Now go to the tab <strong>Mapped Users</strong> - the list will be empty so click <strong>Map users</strong>. At this point you’ll be at the URL <code class="language-plaintext highlighter-rouge">&lt;yourhost&gt;:&lt;yourport&gt;/app/opendistro_security#/roles/edit/public-item-viewer/mapuser</code>.  Under the heading “Internal users” go to the “Internal users” field and select <code class="language-plaintext highlighter-rouge">public-item-user</code>. Then click <strong>Map</strong>.</p>

<p>Now your user (<code class="language-plaintext highlighter-rouge">public-item-user</code>) has all the powers provided by the role <code class="language-plaintext highlighter-rouge">public-item-viewer</code>. Let’s test it out by going to Kibana in a private or incognito window. This trick will allow you to be logged into two users at the same time. Go to Dev Tools (<code class="language-plaintext highlighter-rouge">&lt;yourhost&gt;:&lt;yourport&gt;/app/dev_tools#/console</code>) and enter the following query:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /ecommerce-items/_search
{
  "query": {
    "match" : {
      "title": "brown"
    }
  }
}
</code></pre></div></div>

<p>The result will show:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    ...,
    "hits" : [
        {
        "_index" : "ecommerce-items",
        "_type" : "_doc",
        "_id" : "brown-mug",
        "_score" : 0.13353139,
        "_source" : {
            "title" : "Brown Mug",
                "description" : "This mug features a large handle and a marbled, brown ceramic design.",
                "price" : 5.99
            }
        }
    ]
}
</code></pre></div></div>

<p>Notice that the <code class="language-plaintext highlighter-rouge">private</code> object is gone. Our user and role has filtered this data right out.</p>

<p>One additional note here - we set up these two roles to <em>only</em> have access to this particular index. That means that if,  by some mistake or happenstance the credentials are released for these users or an application bug somehow allows for passing in other indices, you’re covered. No other index managed by Open Distro would be at risk of disclosure as access control is denied when querying. You can think of this as an implementation of the principle of least privilege.</p>

<p>To set up a route for the employee section of your application, create a role called <code class="language-plaintext highlighter-rouge">private-item-viewer</code>  that has permissions to see all information. Repeat the process above, except skipping the step where you exclude <code class="language-plaintext highlighter-rouge">private</code> in the “Field level security section”. Then create a user called <code class="language-plaintext highlighter-rouge">private-item-user</code> with the role of <code class="language-plaintext highlighter-rouge">private-item-viewer</code>. All of the requests from to backend for employees would uses this user to make the requests, enabling them to have access to all the fields in the object <code class="language-plaintext highlighter-rouge">private</code>.</p>

<h2 id="overview-of-the-application-users--roles--search">Overview of the application, users / roles, &amp; search</h2>

<p>As far as your application is concerned, you only need a minimal abstraction to provide different routes with different information. The authenticated route for employees needing to see the private information could reuse all the query preparation, request, serializing, deserializing and rendering code as the public route. Later when your data changes and you want to include or exclude other parts of the document, you don’t have to modify your code, just alter the roles and the application will serve only the fields you specify.</p>

<p><img src="/assets/media/blog-images/2020-10-27-fine-grained-access-control-for-search/credentials-diagram.png" alt="Diagram showing credentials and data flow" class="img-fluid" /></p>

<h2 id="wrap-up">Wrap up</h2>

<p>By using the access control features of Open Distro for Elasticsearch you can reduce the amount of code needed to implement an application that serves differing data from the same index depending on the situation. The pattern outlined above moves the responsibility of data visibility from the application to the search engine. In this way your application can be simpler and you gain centralized, code-free control at the data level.</p>

<p>This pattern can be generalized to many other situations too. Say you have documents that are sensitive to two different groups and neither can see the whole document. Additionally, you have another group that needs to see the whole document, perhaps for security or compliance reasons. Using the same pattern of users, roles and permissions to provide differing visibility of the data with the same queries. But that is a story for another time…</p>
:ET